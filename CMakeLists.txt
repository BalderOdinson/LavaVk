cmake_minimum_required(VERSION 3.14)
project(LavaVK VERSION 0.0.1)

add_subdirectory(lava/third-party)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_FLAGS "-m64 -Wall")

find_package(Vulkan REQUIRED)

include_directories("./")
include_directories("./lava/third-party")

set(LIB_SOURCE lava/framework/dependency-injection/dicontainer.cpp lava/framework/dependency-injection/dicontainer.h lava/framework/object.cpp lava/framework/object.h lava/framework/utils.h lava/framework/dependency-injection/bindingexpression.cpp lava/framework/dependency-injection/bindingexpression.h lava/framework/dependency-injection/injectioncontext.cpp lava/framework/dependency-injection/injectioncontext.h lava/framework/platform/window.cpp lava/framework/platform/window.h lava/framework/platform/application.cpp lava/framework/platform/application.h lava/framework/event-system/event.cpp lava/framework/event-system/event.h lava/framework/platform/inputmanager.cpp lava/framework/platform/inputmanager.h lava/framework/platform/inputeventargs.cpp lava/framework/platform/inputeventargs.h lava/framework/timer.cpp lava/framework/timer.h lava/framework/platform/framecounter.cpp lava/framework/platform/framecounter.h lava/framework/platform/options/applicationoption.cpp lava/framework/platform/options/applicationoption.h lava/framework/platform/options/windowoptions.cpp lava/framework/platform/options/windowoptions.h lava/framework/platform/shared/glfwwindow.cpp lava/framework/platform/shared/glfwwindow.h lava/framework/platform/logger.cpp lava/framework/platform/logger.h lava/framework/platform/shared/defaultlogger.cpp lava/framework/platform/shared/defaultlogger.h lava/framework/platform/linux/linuxwindow.cpp lava/framework/platform/linux/linuxwindow.h lava/framework/platform/linux/linuxapplication.cpp lava/framework/platform/linux/linuxapplication.h lava/framework/scene-graph/component.cpp lava/framework/scene-graph/component.h lava/framework/scene-graph/node.cpp lava/framework/scene-graph/node.h lava/framework/scene-graph/components/transform.cpp lava/framework/scene-graph/components/transform.h lava/framework/scene-graph/script.cpp lava/framework/scene-graph/script.h lava/framework/scene-graph/scene.cpp lava/framework/scene-graph/scene.h lava/framework/core/instance.cpp lava/framework/core/instance.h lava/framework/core/options/instanceoptions.cpp lava/framework/core/options/instanceoptions.h lava/framework/core/device.cpp lava/framework/core/device.h lava/framework/core/surface.cpp lava/framework/core/surface.h lava/framework/core/options/deviceoptions.cpp lava/framework/core/options/deviceoptions.h lava/framework/core/queue.cpp lava/framework/core/queue.h lava/framework/core/options/queueoptions.cpp lava/framework/core/options/queueoptions.h lava/framework/core/queuesubmitrequest.cpp lava/framework/core/queuesubmitrequest.h lava/framework/core/queuepresentrequest.cpp lava/framework/core/queuepresentrequest.h lava/framework/core/allocator.cpp lava/framework/core/allocator.h lava/framework/core/options/allocatoroptions.cpp lava/framework/core/options/allocatoroptions.h lava/framework/core/fence.cpp lava/framework/core/fence.h lava/framework/core/options/fenceoptions.cpp lava/framework/core/options/fenceoptions.h lava/framework/core/semaphore.cpp lava/framework/core/semaphore.h lava/framework/core/commandpool.cpp lava/framework/core/commandpool.h lava/framework/core/commandbuffer.cpp lava/framework/core/commandbuffer.h lava/framework/core/options/commandpooloptions.cpp lava/framework/core/options/commandpooloptions.h lava/framework/core/allocation.cpp lava/framework/core/allocation.h lava/framework/core/options/allocationoption.cpp lava/framework/core/options/allocationoption.h lava/framework/core/buffer.cpp lava/framework/core/buffer.h lava/framework/core/options/bufferoptions.cpp lava/framework/core/options/bufferoptions.h lava/framework/constants.h lava/framework/core/image.cpp lava/framework/core/image.h lava/framework/core/options/imageoptions.cpp lava/framework/core/options/imageoptions.h lava/framework/core/imageobject.cpp lava/framework/core/imageobject.h lava/framework/core/bufferview.cpp lava/framework/core/bufferview.h lava/framework/core/options/bufferviewoptions.cpp lava/framework/core/options/bufferviewoptions.h lava/framework/core/imageview.cpp lava/framework/core/imageview.h lava/framework/vkcommon.h lava/framework/core/options/imageviewoptions.cpp lava/framework/core/options/imageviewoptions.h lava/framework/core/image2buffertransfer.cpp lava/framework/core/image2buffertransfer.h lava/framework/core/buffer2imagetransfer.cpp lava/framework/core/buffer2imagetransfer.h lava/framework/core/buffertransfer.cpp lava/framework/core/buffertransfer.h lava/framework/core/imageupdater.cpp lava/framework/core/imageupdater.h lava/framework/core/deviceimageupdater.cpp lava/framework/core/deviceimageupdater.h lava/framework/core/begintoken.cpp lava/framework/core/begintoken.h lava/framework/core/options/stagingbufferoptions.cpp lava/framework/core/options/stagingbufferoptions.h lava/framework/core/bufferupdater.cpp lava/framework/core/bufferupdater.h lava/framework/core/hostbufferupdater.cpp lava/framework/core/hostbufferupdater.h lava/framework/core/pipelinebarrier.cpp lava/framework/core/pipelinebarrier.h lava/framework/core/devicebufferupdater.cpp lava/framework/core/devicebufferupdater.h lava/framework/core/swapchain.cpp lava/framework/core/swapchain.h lava/framework/core/options/swapchainoptions.cpp lava/framework/core/options/swapchainoptions.h lava/framework/core/swapchainimage.cpp lava/framework/core/swapchainimage.h lava/framework/core/sampler.cpp lava/framework/core/sampler.h lava/framework/core/options/sampleroptions.cpp lava/framework/core/options/sampleroptions.h lava/framework/core/shadermodule.cpp lava/framework/core/shadermodule.h lava/framework/core/options/shadermoduleoptions.cpp lava/framework/core/options/shadermoduleoptions.h lava/framework/core/options/shaderresource.cpp lava/framework/core/options/shaderresource.h lava/framework/core/descriptorsetlayout.cpp lava/framework/core/descriptorsetlayout.h lava/framework/core/descriptorset.cpp lava/framework/core/descriptorset.h lava/framework/dependency-injection/resolveid.cpp lava/framework/dependency-injection/resolveid.h lava/framework/core/options/descriptorsetlayoutoptions.cpp lava/framework/core/options/descriptorsetlayoutoptions.h lava/framework/core/descriptorpool.cpp lava/framework/core/descriptorpool.h lava/framework/core/options/descriptorpooloptions.cpp lava/framework/core/options/descriptorpooloptions.h lava/framework/core/options/descriptorsetoptions.cpp lava/framework/core/options/descriptorsetoptions.h lava/framework/rendering/rendertarget.cpp lava/framework/rendering/rendertarget.h lava/framework/rendering/options/rendertargetoptions.cpp lava/framework/rendering/options/rendertargetoptions.h lava/framework/core/renderpass.cpp lava/framework/core/renderpass.h lava/framework/core/options/renderpassoptions.cpp lava/framework/core/options/renderpassoptions.h lava/framework/core/framebuffer.cpp lava/framework/core/framebuffer.h lava/framework/core/options/framebufferoptions.cpp lava/framework/core/options/framebufferoptions.h lava/framework/bufferpool.cpp lava/framework/bufferpool.h lava/framework/bufferpooloptions.cpp lava/framework/bufferpooloptions.h lava/framework/rendering/renderframe.cpp lava/framework/rendering/renderframe.h lava/framework/fencepool.cpp lava/framework/fencepool.h lava/framework/semaphorepool.cpp lava/framework/semaphorepool.h lava/framework/rendering/options/renderframeoptions.cpp lava/framework/rendering/options/renderframeoptions.h lava/framework/core/pipelinelayout.cpp lava/framework/core/pipelinelayout.h lava/framework/core/options/pipelinelayoutoptions.cpp lava/framework/core/options/pipelinelayoutoptions.h lava/framework/resourcecache.cpp lava/framework/resourcecache.h lava/framework/rendering/pipelinestate.cpp lava/framework/rendering/pipelinestate.h lava/framework/core/pipeline.cpp lava/framework/core/pipeline.h lava/framework/core/options/pipelineoptions.cpp lava/framework/core/options/pipelineoptions.h lava/framework/core/computepipeline.cpp lava/framework/core/computepipeline.h lava/framework/core/graphicspipeline.cpp lava/framework/core/graphicspipeline.h lava/framework/rendering/rendercontext.cpp lava/framework/rendering/rendercontext.h lava/framework/scene-graph/components/image.cpp lava/framework/scene-graph/components/image.h lava/framework/core/options/devicememoryupdateoptions.cpp lava/framework/core/options/devicememoryupdateoptions.h lava/framework/scene-graph/components/aabb.cpp lava/framework/scene-graph/components/aabb.h lava/framework/scene-graph/components/camera.cpp lava/framework/scene-graph/components/camera.h lava/framework/scene-graph/components/light.cpp lava/framework/scene-graph/components/light.h lava/framework/scene-graph/components/material.cpp lava/framework/scene-graph/components/material.h lava/framework/scene-graph/components/sampler.cpp lava/framework/scene-graph/components/sampler.h lava/framework/scene-graph/components/texture.cpp lava/framework/scene-graph/components/texture.h lava/framework/scene-graph/components/pbrmaterial.cpp lava/framework/scene-graph/components/pbrmaterial.h lava/framework/scene-graph/components/perspectivecamera.cpp lava/framework/scene-graph/components/perspectivecamera.h lava/framework/scene-graph/components/submesh.cpp lava/framework/scene-graph/components/submesh.h lava/framework/scene-graph/components/mesh.cpp lava/framework/scene-graph/components/mesh.h lava/framework/scene-graph/scripts/freecamera.cpp lava/framework/scene-graph/scripts/freecamera.h lava/framework/scene-graph/scripts/nodeanimation.cpp lava/framework/scene-graph/scripts/nodeanimation.h lava/framework/rendering/subpass.cpp lava/framework/rendering/subpass.h lava/framework/rendering/options/subpassoptions.cpp lava/framework/rendering/options/subpassoptions.h lava/framework/rendering/renderpipeline.cpp lava/framework/rendering/renderpipeline.h lava/framework/rendering/options/renderpipelineoptions.cpp lava/framework/rendering/options/renderpipelineoptions.h lava/framework/core/imagetransfer.cpp lava/framework/core/imagetransfer.h lava/framework/resourcebindingstate.cpp lava/framework/resourcebindingstate.h lava/framework/rendering/subpasses/geometrysubpass.cpp lava/framework/rendering/subpasses/geometrysubpass.h lava/framework/rendering/subpasses/options/geometrysubpassoptions.cpp lava/framework/rendering/subpasses/options/geometrysubpassoptions.h lava/framework/scene-graph/components/particleeffect.cpp lava/framework/scene-graph/components/particleeffect.h lava/framework/resourcecacheoptions.cpp lava/framework/resourcecacheoptions.h lava/framework/multisamplingoptions.cpp lava/framework/multisamplingoptions.h lava/framework/images/imagesource.cpp lava/framework/images/imagesource.h lava/framework/images/imageloader.cpp lava/framework/images/imageloader.h lava/framework/images/fileimagesource.cpp lava/framework/images/fileimagesource.h lava/framework/images/bitmapimageloader.cpp lava/framework/images/bitmapimageloader.h lava/framework/images/compressedimageloader.cpp lava/framework/images/compressedimageloader.h lava/framework/images/memoryimagesource.cpp lava/framework/images/memoryimagesource.h lava/framework/images/cubemapfileimagesource.cpp lava/framework/images/cubemapfileimagesource.h lava/framework/scene-graph/components/skybox.cpp lava/framework/scene-graph/components/skybox.h lava/framework/images/mipmapsoptions.cpp lava/framework/images/mipmapsoptions.h lava/framework/meshes/vertexoptions.cpp lava/framework/meshes/vertexoptions.h lava/framework/meshes/vertexsource.cpp lava/framework/meshes/vertexsource.h lava/framework/meshes/memoryvertexsource.cpp lava/framework/meshes/memoryvertexsource.h lava/framework/meshes/objectfilevertexsource.cpp lava/framework/meshes/objectfilevertexsource.h lava/framework/images/defaultimagesource.cpp lava/framework/images/defaultimagesource.h lava/framework/materials/materialsource.cpp lava/framework/materials/materialsource.h lava/framework/materials/memorymaterialsource.cpp lava/framework/materials/memorymaterialsource.h lava/framework/materials/objectfilematerialsource.cpp lava/framework/materials/objectfilematerialsource.h lava/framework/meshes/meshsource.cpp lava/framework/meshes/meshsource.h lava/framework/meshes/memorymeshsource.cpp lava/framework/meshes/memorymeshsource.h lava/framework/meshes/objectfilemeshsource.cpp lava/framework/meshes/objectfilemeshsource.h lava/framework/materials/basematerialsource.cpp lava/framework/materials/basematerialsource.h lava/framework/scene-graph/components/specularmaterial.cpp lava/framework/scene-graph/components/specularmaterial.h lava/framework/rendering/subpasses/componentrenderer.cpp lava/framework/rendering/subpasses/componentrenderer.h lava/framework/rendering/subpasses/renderers/meshrenderer.cpp lava/framework/rendering/subpasses/renderers/meshrenderer.h lava/framework/rendering/subpasses/renderers/options/geometryrenderoptions.cpp lava/framework/rendering/subpasses/renderers/options/geometryrenderoptions.h lava/framework/rendering/subpasses/renderers/specularmeshrenderer.cpp lava/framework/rendering/subpasses/renderers/specularmeshrenderer.h lava/framework/rendering/subpasses/renderers/pbrmeshrenderer.cpp lava/framework/rendering/subpasses/renderers/pbrmeshrenderer.h lava/framework/rendering/subpasses/renderers/forwardlightsrenderer.cpp lava/framework/rendering/subpasses/renderers/forwardlightsrenderer.h lava/framework/rendering/subpasses/renderers/options/forwardlightsrendereroptions.cpp lava/framework/rendering/subpasses/renderers/options/forwardlightsrendereroptions.h lava/framework/scene-graph/components/specularlight.cpp lava/framework/scene-graph/components/specularlight.h lava/framework/rendering/subpasses/renderers/forwardspecularlightsrenderer.cpp lava/framework/rendering/subpasses/renderers/forwardspecularlightsrenderer.h lava/framework/scene-graph/components/geometry.cpp lava/framework/scene-graph/components/geometry.h lava/framework/rendering/subpasses/renderers/skyboxrenderer.cpp lava/framework/rendering/subpasses/renderers/skyboxrenderer.h lava/framework/time.cpp lava/framework/time.h lava/framework/rendering/subpasses/renderers/particlerenderer.cpp lava/framework/rendering/subpasses/renderers/particlerenderer.h lava/framework/scene-graph/components/pathgeometry.cpp lava/framework/scene-graph/components/pathgeometry.h lava/framework/scene-graph/components/cubicbspline.cpp lava/framework/scene-graph/components/cubicbspline.h lava/framework/rendering/subpasses/renderers/pathrenderer.cpp lava/framework/rendering/subpasses/renderers/pathrenderer.h lava/framework/rendering/subpasses/renderers/cubicbsplinerenderer.cpp lava/framework/rendering/subpasses/renderers/cubicbsplinerenderer.h lava/framework/sceneloader.cpp lava/framework/sceneloader.h lava/framework/loadingscreenloader.cpp lava/framework/loadingscreenloader.h lava/framework/scene-graph/scripts/staticcamera.cpp lava/framework/scene-graph/scripts/staticcamera.h lava/core.h lava/dependencyinjection.h lava/loaders.h lava/rendering.h lava/scene-graph.h lava/framework/platform/windows/win32window.cpp lava/framework/platform/windows/win32window.h lava/framework/platform/windows/windowsapplication.cpp lava/framework/platform/windows/windowsapplication.h lava/framework/app.h lava/platform.h lava/framework.h lava/lava.h lava/framework/rendering/subpasses/lightsubpass.cpp lava/framework/rendering/subpasses/lightsubpass.h lava/framework/rendering/subpasses/lightrenderer.cpp lava/framework/rendering/subpasses/lightrenderer.h lava/framework/rendering/subpasses/lights/basiclightrenderer.cpp lava/framework/rendering/subpasses/lights/basiclightrenderer.h lava/framework/rendering/subpasses/lights/options/basiclightoptions.cpp lava/framework/rendering/subpasses/lights/options/basiclightoptions.h lava/framework/rendering/subpasses/lights/specularlightrenderer.cpp lava/framework/rendering/subpasses/lights/specularlightrenderer.h lava/framework/rendering/subpasses/options/lightsubpassoptions.cpp lava/framework/rendering/subpasses/options/lightsubpassoptions.h lava/framework/rendering/subpasses/renderers/deferredrenderer.cpp lava/framework/rendering/subpasses/renderers/deferredrenderer.h lava/framework/rendering/subpasses/renderers/options/deferredrendereroptions.cpp lava/framework/rendering/subpasses/renderers/options/deferredrendereroptions.h lava/framework/rendering/subpasses/renderers/deferredspecularrenderer.cpp lava/framework/rendering/subpasses/renderers/deferredspecularrenderer.h lava/framework/gl_includer.h)

if (CMAKE_BUILD_TYPE MATCHES "Debug")
    if(NOT CMAKE_CXX_COMPILER_ID MATCHES "MSVC")
        set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -pthread")
    endif()
elseif (CMAKE_BUILD_TYPE MATCHES "Release")
    if(NOT CMAKE_CXX_COMPILER_ID MATCHES "MSVC")
        set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -O2 -mtune=native -pthread")
    else()
        set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /O2")
    endif()
endif ()

add_library(LavaVK STATIC ${LIB_SOURCE})
target_compile_definitions(LavaVK PUBLIC VULKAN_HPP_DISPATCH_LOADER_DYNAMIC=1)

target_link_libraries(LavaVK ${CMAKE_DL_LIBS})
target_link_libraries(LavaVK vulkan)
target_link_libraries(LavaVK glfw)
target_link_libraries(LavaVK glm)
target_link_libraries(LavaVK vma)
target_link_libraries(LavaVK stb)
target_link_libraries(LavaVK tinyobj)
target_link_libraries(LavaVK gli)

set(GLSL_VALIDATOR "glslc")

file(GLOB_RECURSE GLSL_SOURCE_FILES
        "shaders/*.frag"
        "shaders/*.vert"
        "shaders/*.tesc"
        "shaders/*.tese"
        "shaders/*.geom"
        "shaders/*.comp")

foreach(GLSL ${GLSL_SOURCE_FILES})
    get_filename_component(FILE_NAME ${GLSL} NAME)
    set(SPIRV "${CMAKE_BINARY_DIR}/shaders/${FILE_NAME}.spv")
    add_custom_command(
            OUTPUT ${SPIRV}
            COMMAND ${CMAKE_COMMAND} -E make_directory "${CMAKE_BINARY_DIR}/shaders/"
            COMMAND ${GLSL_VALIDATOR} ${GLSL} -o ${SPIRV}
            DEPENDS ${GLSL})
    list(APPEND SPIRV_BINARY_FILES ${SPIRV})
endforeach(GLSL)

add_custom_target(
        Shaders
        DEPENDS ${SPIRV_BINARY_FILES})

add_dependencies(LavaVK Shaders)

#[[add_custom_command(TARGET LavaVK POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E make_directory "${CMAKE_BINARY_DIR}/shaders/"
        COMMAND ${CMAKE_COMMAND} -E copy_directory
        "${PROJECT_BINARY_DIR}/shaders"
        "${CMAKE_BINARY_DIR}/shaders")]]
